#!/usr/bin/env bash
set -euo pipefail

operation=${1:-}

# Drain stdin for git credential protocol
while IFS= read -r line && [[ -n "$line" ]]; do :; done

if [[ "$operation" != "get" ]]; then
  exit 0
fi

# Prefer existing token environment variable
if [[ -n "${GITHUB_ACCESS_TOKEN:-}" ]]; then
  token="$GITHUB_ACCESS_TOKEN"
else
  if [[ -z "${GH_TOKEN_ID:-}" ]]; then
    echo "GH_TOKEN_ID environment variable not set" >&2
    exit 1
  fi
  if ! command -v bws >/dev/null; then
    echo "bws command not found" >&2
    exit 1
  fi
  if ! command -v jq >/dev/null; then
    echo "jq command not found" >&2
    exit 1
  fi
  token="$(bws secret get "$GH_TOKEN_ID" -o json | jq -r .value)"
  if [[ -z "$token" ]]; then
    echo "Failed to retrieve GitHub token" >&2
    exit 1
  fi
fi

echo "username=x-access-token"
echo "password=$token"
